<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="generator" content="Docusaurus v2.0.0-alpha.50">
<script src="./js/dark_default.js"></script>

<title data-react-helmet="true">pbr_part2 | jMonkeyEngine Documentation</title>

<meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="pbr_part2 | jMonkeyEngine Documentation"><meta data-react-helmet="true" name="description" content="[In Part one](../../jme3\advanced\pbr_part1), I explained what you"><meta data-react-helmet="true" property="og:description" content="[In Part one](../../jme3\advanced\pbr_part1), I explained what you"><meta data-react-helmet="true" property="og:url" content="https://8keep.github.io/wikidemo/docs/jme3/advanced/pbr_part2">

<link data-react-helmet="true" rel="shortcut icon" href="/wikidemo/img/favicon.ico">


<link rel="stylesheet" href="/wikidemo/styles.7d008dc0.css">


<link rel="preload" href="/wikidemo/styles.08ff7081.js" as="script">

<link rel="preload" href="/wikidemo/runtime~main.7418f8ca.js" as="script">

<link rel="preload" href="/wikidemo/main.0c3323ac.js" as="script">

<link rel="preload" href="/wikidemo/1.e501629b.js" as="script">

<link rel="preload" href="/wikidemo/2.c824d386.js" as="script">

<link rel="preload" href="/wikidemo/302.1d1a2997.js" as="script">

<link rel="preload" href="/wikidemo/394d525a.30c299b8.js" as="script">

<link rel="preload" href="/wikidemo/17896441.d065d5f5.js" as="script">

<link rel="preload" href="/wikidemo/61c8fcf8.9cb323fd.js" as="script">

</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=window.matchMedia("(prefers-color-scheme: dark)"),n=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==n?t(n):e.matches&&t("dark")}()</script>
<div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a aria-current="page" class="navbar__brand active" href="/wikidemo/"><img class="navbar__logo" src="/wikidemo/img/iconx128.png" alt="JmonkeyEngine"><strong class="navbar__title"></strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wikidemo/docs/documentation">Docs</a></div><div class="navbar__items navbar__items--right"><a target="_blank" rel="noopener noreferrer" href="https://github.com/8keep/wikidemo" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_1gtM"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_keGJ moon_1gwN"></span></div><div class="react-toggle-track-x"><span class="toggle_keGJ sun_3CPA"></span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a aria-current="page" class="navbar__brand active" href="/wikidemo/"><img class="navbar__logo" src="/wikidemo/img/iconx128.png" alt="JmonkeyEngine"><strong class="navbar__title"></strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wikidemo/docs/documentation">Docs</a></li><li class="menu__list-item"><a target="_blank" rel="noopener noreferrer" href="https://github.com/8keep/wikidemo" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_1kjD"><main class="docMainContainer_FFX1"><div class="padding-vert--lg"><div class="container"><div class="row"><div class="col docItemCol_2GOA"><div class="docItemContainer_2cwg"><article><header><h1 class="docTitle_1vWb">pbr_part2</h1></header><div class="markdown"><p><a href="/wikidemo/docs/jme3\advanced\pbr_part1">In Part one</a>, I explained what you
had to know about Physically Based Rendering if you were an artist. If
you&#x27;re a developer, and reading this article, you may have tried, or are
planning to implement your own PBR system. If you started to read some
of the available literature, you&#x27;ve probably been struck by the math
complexity of it, and by the lack of explanation of the big picture. You
usually see articles that focus on specifics parts of the process, and
don&#x27;t talk much about other parts as they are assumed easier. At some
point you have to assemble all these parts, and I had a hard time
figuring out how to do it in my readings. I guess it&#x27;s considered basic
stuff for other authors, but I think it deserves its proper explanation.</p><p>I don&#x27;t pretend these articles will enlighten you to the point you are
ready to implement your own system, but I hope they will give you solid
basis and understanding to start reading the literature without saying
&quot;WTF?? on every line as I did.</p><p>You can find a lexical, at the end, with all the strange words you&#x27;ll
come across and their explanations.</p><p>So here is what I figured out about using PBR and lighting in general in
a 3D rendering pipeline.</p><p><strong>Ligthing</strong></p><p>So first, lets talk about lighting in games. It all boils down to 2
things :</p><ul><li><p>Computing <strong>Diffuse</strong> reflection: This represent the light that
reflects off a surface in all directions</p></li><li><p>Computing <strong>Specular</strong> reflection : This represent the light that
reflects off a surface directly to your eye.</p></li></ul><p>This image from wikipedia is the most simple and yet the most helpful to
understand this</p><p><img src="/images/jme3/advanced/Lambert2.png" alt="Lambert2"></p><p>By GianniG46 (Own work) [CC-BY-SA-3.0
(<a href="http://creativecommons.org/licenses/by-sa/3.0">http://creativecommons.org/licenses/by-sa/3.0</a>) or GFDL
(<a href="http://www.gnu.org/copyleft/fdl.html">http://www.gnu.org/copyleft/fdl.html</a>)], via Wikimedia Commons</p><p>To compute each of these factors, we&#x27;re going to use a function. This
function answers to the delicate name of <strong>Bidirectional Reflectance
Distribution Function or BRDF</strong>.</p><p>Don&#x27;t be scared by this, it&#x27;s a big name for just a function really.
Usually, it will be a shader function.</p><p>Of course there are different BRDFs depending on what you want to
compute, and on the lighting model you use. The BRDFs are usually called
by the name of the guys that discovered/elaborated them.</p><p>Also, most of the time, in implementations for real time rendering,
those BRDFs are approximated for the sake of performance. And
incidentally, those approximations also have names, that can be people
names or technique names...</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lighting-in-pbr"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#lighting-in-pbr" title="Direct link to heading">#</a>Lighting in PBR</h1><p>Computing lighting for PBR is exactly the same as with the current
rendering ( the system we use today with ambient, diffuse, specular,
sometimes called ad-hoc system in the literature) :</p><p>For each light source, compute the diffuse factor and the specular
factor. The main difference is that the BRDFs used are different, more
physically accurate, and works predictably under different light sources
with few parameter entries.</p><p>So what is a light source?</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="direct-light-source"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#direct-light-source" title="Direct link to heading">#</a>Direct light source</h2><p>Something that emits light. In games the most common light sources are
Directional lights (think of the sun), Spot lights (think of a torch
light), Point lights (think of a light bulb).</p><p>That&#x27;s what is commonly used in the ad-hoc system, and PBR also handle
those types of lights.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="indirect-light-source"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#indirect-light-source" title="Direct link to heading">#</a>Indirect light source</h2><p>Something that reflects light and indirectly lights its surroundings.
Think for example of a red wall next to a car at daytime, the sunlight
hits the wall and the wall reflects red light that, in turn, lights up
the car.</p><p>This is not handled by the ad-hoc system, or very poorly faked with
ambient lighting.</p><p>This part is optional for PBR, but that&#x27;s actually the part you really
want. because that&#x27;s what make things pretty!</p><p>In games, indirect lighting is done by using an environment map as a
light source. This technique is called <strong>Image Based Lighting (IBL)</strong>.</p><p>So let&#x27;s say we&#x27;re looking for the full package. we need to compute
diffuse and specular contribution for each light source be it direct or
indirect.</p><p>To do so we need a BRDF for diffuse and a BRDF for specular, and stick
to them for each light source for consistency. Also those BRDF should
accept as entry the parameters we want to expose for the artists (base
color, metalness, roughness), or derived parameters with minimal
transformation.</p><p>So the pseudo code for a complete lighting is this :</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">//direct lighting</span></div><div class="token-line" style="color:#393A34"><span class="token plain">for each directLightSource {</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    directDiffuseFactor = DiffuseBRDF(directlightSource)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    directSpecularFactor = SpecularBRDF(directLightSource)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">    directLighting += Albedo * directDiffuseFactor + SpecColor * directSpecularFactor</span></div><div class="token-line" style="color:#393A34"><span class="token plain">}</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">//Indirect Lighting, done through Image Based Rendering with an environment map</span></div><div class="token-line" style="color:#393A34"><span class="token plain">indirectDiffuseFactor = DiffuseBRDF(EnvMap)</span></div><div class="token-line" style="color:#393A34"><span class="token plain">indirectSpecularFactor = SpecularBRDF(EnvMap)</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">indirectLighting = Albedo * indirectDiffuseFactor + SpecColor * indirectSpecularFactor</span></div><div class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#393A34"><span class="token plain">Lighting = directLighting + indirectLighting</span></div></div></div></div></div><p>I&#x27;ll go into more details, in the posts serie, on how to compute each
factors, but that&#x27;s pretty much it.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="choosing-your-brdfs"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#choosing-your-brdfs" title="Direct link to heading">#</a>Choosing your BRDFs</h1><p>There is a vast choice of BRDF, and I&#x27;m not going to talk about all of
them but focus on the ones that I use in my implementation. I&#x27;ll just
guide you to alternatives and provide links to relevant articles for
more details.</p><p>I chose to use the same BRDF as the ones used in Unreal Engine 4 from
<a href="http://blog.selfshadow.com/publications/s2013-shading-course/karis/s2013_pbs_epic_notes_v2.pdf">this
article</a>
by Brian Karis, as I completely trust his judgement. The provided code
helped a great deal, but it was far from straight forward to integrate.
In the end I had to fully research, and understand all the whereabouts
of BRDFs.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="diffuse-brdf--lambert"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#diffuse-brdf--lambert" title="Direct link to heading">#</a>Diffuse BRDF : Lambert</h2><p>The most used diffuse BRDF in games. It&#x27;s very popular because it&#x27;s very
cheap to compute and gives good results. This is the most simple way of
computing diffuse. <a href="https://en.wikipedia.org/wiki/Lambertian_reflectance">here are the
details</a></p><p><img src="/images/jme3/advanced/DiffuseLambert.jpg" alt="DiffuseLambert"></p><p>Diffuse Lambert factor for a direct light source (directional light)
with a yellow surface color.</p><p>Some Alternatives :</p><p><strong>Oren-Nayar</strong> : Gives better visual results than classic Lambert, and
has the advantage of using an entry parameter called roughness...rings a
bell? Unfortunately, the additional computation cost is not really worth
it,IMO. <a href="https://en.wikipedia.org/wiki/Oren%E2%80%93Nayar_reflectance_model">Details
here</a></p><p><strong>Harahan-Krueger</strong> : Takes into consideration sub-surface scattering
for diffuse lighting (every material surface has layers and light
scatters into those different layers before going out of the material in
a random direction). A lot of computations compared to Lambert, but may
be important if you want to have a good sub surface scattering look for
skin for example. <a href="http://cseweb.ucsd.edu/~ravir/6998/papers/p165-hanrahan.pdf">more details in this
paper</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="specular-brdf--cook-torrance"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#specular-brdf--cook-torrance" title="Direct link to heading">#</a>Specular BRDF : Cook-Torrance</h2><p>This is a bit more complicated for specular. We need a physically
plausible BRDF. We use what is called a <strong>Microfacet BRDF</strong>. So what is
it?</p><p>It states that at a micro level a surface is not plane, but formed of a
multitude of little randomly aligned surfaces, the microfacets. Those
surfaces acts as small mirrors that reflects incoming light. The idea
behind this BRDF is that only some of those facets may be oriented so
that the incoming light reflects to your eye. The smoother the surface,
the more all facets are aligned, and the most neat is the light
reflection. In the contrary, if a surface is rough, the facets are more
randomly oriented so the light reflection is scattered on the surface,
and the reflection looks more blurry.</p><p><img src="/images/jme3/advanced/DiffuseLambert.jpg" alt="Specular"></p><p>Microfacet specular factor for a direct light source. On the left a
smooth surface, on the right a rough one. Note how the reflection is
scattered on the surface when it&#x27;s rough.</p><p>The microfacet BRDF we use is called Cook-Torrance. From my readings, I
couldn&#x27;t find any implementation that use another specular BRDF. It
seems like this is the global form of any microfacet BRDF.</p><div class="mdxCodeBlock_iHAB"><div class="codeBlockContent_32p_"><button type="button" aria-label="Copy code to clipboard" class="copyButton_1BYj">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_19pQ"><div class="codeBlockLines_2n9r" style="color:#393A34;background-color:#f6f8fa"><div class="token-line" style="color:#393A34"><span class="token plain">f = D * F * G / (4 * (N.L) * (N.V));</span></div></div></div></div></div><p><strong>N.L</strong> is the dot product between the normal of the shaded surface and
the light direction.</p><p><strong>N.V</strong> is the dot product between the normal of the shaded surface and
the view direction.</p><p>The other terms are :</p><ul><li><p><strong>Normal Distribution Function called D</strong> (for distribution). You
may also find some references to it as NDF. It computes the
distribution of the microfacets for the shaded surface</p></li><li><p><strong>Fresnel factor called F</strong>. Discovered by Augustin Fresnel
(frenchies are sooo clever), it describes how light reflects and
refracts at the intersection of two different media (most often in
computer graphics : Air and the shaded surface)</p></li><li><p><strong>Geometry shadowing term G</strong>. Defines the shadowing from the
microfacets</p></li></ul><p>That&#x27;s where it gets complicated. For each of these terms, there are
several models or approximations to computed them.</p><p>I&#x27;ve settled to use those models and approximations :</p><ul><li><p><strong>D : Trowbridge-Reitz/GGX</strong> normal Distribution function.</p></li><li><p><strong>F : Fresnel term Schlick</strong>&#x27;s
<a href="http://www.cs.virginia.edu/~jdl/bib/appearance/analytic%20models/schlick94b.pdf">approximation</a></p></li><li><p><strong>G : Schlick-GGX</strong> approximation</p></li></ul><p>I won&#x27;t go into the details of all the alternatives I just want to
expose an overview of the whole process first. But I&#x27;ll dive into more
technical details on the terms I use, in following posts. To have a neat
overview of all alternatives you can see this
<a href="http://graphicrants.blogspot.fr/2013/08/specular-brdf-reference.html">post</a>
on Brian Karis&#x27;s blog.</p><p>That sums up the whole process, but there is still much to explain. In
next post I&#x27;ll make a focus on indirect lighting, as it&#x27;s the part that
gave me the hardest time to wrap my head around. I&#x27;ll explain the Image
Based Lighting technique used, and how you can compute diffuse and
specular from an Environment Map.</p><h1><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_ZqCz" id="lexical-"></a><a aria-hidden="true" tabindex="-1" class="hash-link" href="#lexical-" title="Direct link to heading">#</a>Lexical :</h1><p><strong>Diffuse reflection :</strong> light that reflects from a surface in every
direction.</p><p><strong>Specular reflection :</strong> light that reflects from a surface toward the
viewer.</p><p><strong>Bidirectional Reflectance Distribution Function or BRDF :</strong> a function
to compute Diffuse or Specular reflection.</p><p><strong>Image Based Rendering or IBL :</strong> a technique that uses an image as a
light source</p><p><strong>Microfacet Specular BRDF :</strong> A specular BRDF that assumes a surface is
made of a multitude of very small randomly aligned surfaces: the
microfacets. it depends on 3 factors called D, F and G.</p><p><strong>Normal Distribution Function called D</strong> (for distribution). You may
also find some references to it as NDF. It computes the distribution of
the microfacets for the shaded surface</p><p><strong>Fresnel factor called F</strong>. Discovered by Augustin Fresnel (frenchies
are sooo clever), it describes how light reflects and refracts at the
intersection of two different media (most often in computer graphics :
Air and the shaded surface)</p><p><strong>Geometry shadowing term G</strong>. Defines the shadowing from the micro
facets</p><ul><li><p><a href="/wikidemo/docs/jme3\advanced\pbr_part1">Physically Based Rendering -- Part
one</a></p></li><li><p><a href="/wikidemo/docs/jme3\advanced\pbr_part3">Physically Based Rendering -- Part
Three</a></p></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/8keep/wikidemo/edit/master/docs/jme3/advanced/pbr_part2.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_TbNY"><ul class="contents contents__left-border"><li><a href="#direct-light-source" class="contents__link">Direct light source</a></li><li><a href="#indirect-light-source" class="contents__link">Indirect light source</a></li><li><a href="#diffuse-brdf--lambert" class="contents__link">Diffuse BRDF : Lambert</a></li><li><a href="#specular-brdf--cook-torrance" class="contents__link">Specular BRDF : Cook-Torrance</a></li></ul></div></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="text--center"><div>Copyright © 2020 jMonkeyEngine.</div></div></div></footer>
</div>

<script src="/wikidemo/styles.08ff7081.js"></script>

<script src="/wikidemo/runtime~main.7418f8ca.js"></script>

<script src="/wikidemo/main.0c3323ac.js"></script>

<script src="/wikidemo/1.e501629b.js"></script>

<script src="/wikidemo/2.c824d386.js"></script>

<script src="/wikidemo/302.1d1a2997.js"></script>

<script src="/wikidemo/394d525a.30c299b8.js"></script>

<script src="/wikidemo/17896441.d065d5f5.js"></script>

<script src="/wikidemo/61c8fcf8.9cb323fd.js"></script>


</body>
</html>